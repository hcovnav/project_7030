<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chevron-icon {
            transition: transform 0.2s ease-in-out;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .email-body {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="container mx-auto p-4 md:p-8">
    <div class="w-full max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8">

        <!-- Header Section -->
        <div class="flex flex-col sm:flex-row items-center text-center sm:text-left">
            <div class="flex-shrink-0 mb-4 sm:mb-0 sm:mr-6">
                <div class="h-20 w-20 bg-indigo-100 rounded-full flex items-center justify-center">
                    <svg class="w-12 h-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                    </svg>
                </div>
            </div>
            <div>
                <h1 id="profile-header" class="text-2xl md:text-3xl font-bold text-gray-800">User Account Details</h1>
                <p class="text-gray-500 mt-1">
                    Viewing details for Account RID: <span id="user-rid" class="font-semibold text-indigo-600">{{ account_rid }}</span>
                </p>
            </div>
        </div>

        <!-- Data Display Section -->
        <div id="data-container" class="mt-8 text-left">
            <!-- Loading State -->
            <div id="loading-state" class="flex flex-col items-center justify-center p-8">
                <div class="spinner"></div>
                <p class="mt-4 text-gray-600">Correlating user data...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden flex-col items-center justify-center p-8 bg-red-50 border border-red-200 rounded-lg">
                <!-- Error Icon and Message -->
            </div>

            <!-- Success State -->
            <div id="success-state" class="hidden space-y-6">
                <!-- 1. Forensic Summary Table -->
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-3">Forensic Summary</h2>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <tbody id="profile-details-list" class="bg-white divide-y divide-gray-200">
                            <!-- Combined data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Expandable Raw Data Sections -->
                <div class="space-y-4 pt-4 border-t">
                    <!-- Emails Expander -->
                    <div>
                        <button id="toggle-emails" class="w-full flex justify-between items-center text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <span class="font-semibold text-gray-700">Emails</span>
                            <svg class="chevron-icon w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="emails-container" class="hidden mt-2 p-4 border border-gray-200 rounded-lg space-y-4">
                            <!-- AI Summary Section -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">AI Summary</h3>
                                <div id="ai-summary-container">
                                    <div id="ai-summary-loading" class="flex items-center p-4 rounded-lg bg-gray-50">
                                        <div class="spinner h-5 w-5 mr-3"></div>
                                        <span>Analyzing emails...</span>
                                    </div>
                                    <div id="ai-summary-content" class="hidden">
                                        <!-- Parsed AI summary will be injected here -->
                                    </div>
                                </div>
                            </div>
                            <!-- Emails Table Section -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Email Details</h3>
                                <div id="emails-table-container" class="overflow-x-auto border border-gray-200 rounded-lg">
                                    <div id="emails-loading" class="flex items-center justify-center p-6">
                                        <div class="spinner h-6 w-6 mr-3"></div>
                                        <span>Loading emails...</span>
                                    </div>
                                    <table class="min-w-full divide-y divide-gray-200 hidden">
                                        <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        </tr>
                                        </thead>
                                        <tbody id="emails-list" class="bg-white divide-y divide-gray-200">
                                        <!-- Email rows will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- UAC Flags Expander -->
                    <div>
                        <button id="toggle-uac-flags" class="w-full flex justify-between items-center text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <span class="font-semibold text-gray-700">Show UAC Flag Details</span>
                            <svg class="chevron-icon w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="uac-flags-container" class="hidden mt-2 p-4 border border-gray-200 rounded-lg space-y-4">
                            <!-- UAC Flag details will be inserted here -->
                        </div>
                    </div>
                    <!-- F-Value Expander -->
                    <div>
                        <button id="toggle-f-value" class="w-full flex justify-between items-center text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <span class="font-semibold text-gray-700">Show Raw F-Value Details</span>
                            <svg class="chevron-icon w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="raw-f-value-container" class="hidden mt-2 overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200"><tbody id="raw-f-value-list" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                    </div>

                    <!-- V-Value Expander -->
                    <div>
                        <button id="toggle-v-value" class="w-full flex justify-between items-center text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <span class="font-semibold text-gray-700">Show Raw V-Value Details</span>
                            <svg class="chevron-icon w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <div id="raw-v-value-container" class="hidden mt-2 overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200"><tbody id="raw-v-value-list" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 border-t pt-6 text-center">
            <a href="{{ url_for('dashboard') }}" class="inline-block bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- UI Elements ---
        const loadingState = document.getElementById('loading-state');
        const successState = document.getElementById('success-state');
        const profileHeader = document.getElementById('profile-header');
        const profileDetailsList = document.getElementById('profile-details-list');

        // Emails Expander
        const toggleEmailsBtn = document.getElementById('toggle-emails');
        const emailsContainer = document.getElementById('emails-container');
        const aiSummaryContainer = document.getElementById('ai-summary-container');
        const aiSummaryLoading = document.getElementById('ai-summary-loading');
        const aiSummaryContent = document.getElementById('ai-summary-content');
        const emailsTableContainer = document.getElementById('emails-table-container');
        const emailsLoading = document.getElementById('emails-loading');
        const emailsList = document.getElementById('emails-list');

        // UAC Flags Expander
        const toggleUACBtn = document.getElementById('toggle-uac-flags');
        const uacFlagsContainer = document.getElementById('uac-flags-container');

        // F-Value Expander
        const toggleFValueBtn = document.getElementById('toggle-f-value');
        const rawFValueContainer = document.getElementById('raw-f-value-container');
        const rawFValueList = document.getElementById('raw-f-value-list');

        // V-Value Expander
        const toggleVValueBtn = document.getElementById('toggle-v-value');
        const rawVValueContainer = document.getElementById('raw-v-value-container');
        const rawVValueList = document.getElementById('raw-v-value-list');

        // --- Template Data ---
        const partitionId = '{{ partition_id }}' || '1'; // Fallback for testing
        const userRid = '{{ account_rid }}' || '1000'; // Fallback for testing

        // --- API Endpoints ---
        const fValueApiUrl = `/api/partition/${partitionId}/get_user_f_value_data_with_rid/${userRid}`;
        const vValueApiUrl = `/api/partition/${partitionId}/get_user_v_value_data_with_rid/${userRid}`;
        const fValueFlagsApiUrl = `/api/partition/${partitionId}/get_user_f_value_flags_with_rid/${userRid}`;
        const emailsApiUrl = `/api/partition/${partitionId}/get_user_emails/${userRid}`;
        const emailAiAnalysisApiUrl = `http://127.0.0.1:5001/api/partition/${partitionId}/email_ai_analysis/${userRid}`;


        // --- Helper Functions ---
        const findValue = (dataArray, fieldName) => {
            const item = dataArray.find(d => d.field === fieldName);
            return item ? item.value : '<span class="text-gray-400 italic">Not found</span>';
        };

        const createDetailRow = (label, value, highlight = false) => {
            const displayValue = (String(value).trim() === '' || value === null || value === undefined)
                ? '<span class="text-gray-400 italic">Not set</span>'
                : value;
            const valueClass = highlight ? 'text-indigo-600 font-semibold' : 'text-gray-700';

            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 align-top">${label}</td>
                    <td class="px-6 py-4 whitespace-normal text-sm ${valueClass}">${displayValue}</td>
                </tr>
            `;
        };

        const delay = ms => new Promise(res => setTimeout(res, ms));

        // --- Render Functions ---
        const renderCombinedProfile = (fData, vData) => {
            const username = findValue(vData, 'Username');
            profileHeader.textContent = `Profile: ${username}`;

            let detailsHtml = '';
            detailsHtml += createDetailRow('Username', username, true);
            detailsHtml += createDetailRow('Full Name', findValue(vData, 'Full Name'));
            detailsHtml += createDetailRow('Description', findValue(vData, 'User Comment'));
            detailsHtml += createDetailRow('Last Logon (Any Type)', findValue(fData, 'Last Logon Timestamp'), true);
            detailsHtml += createDetailRow('Last Interactive Logon', findValue(vData, 'Last Login Timestamp'));
            detailsHtml += createDetailRow('Password Last Set', findValue(fData, 'Password Last Set Timestamp'));
            detailsHtml += createDetailRow('Login Count', findValue(fData, 'Login Count'));
            profileDetailsList.innerHTML = detailsHtml;
        };

        const renderUACFlags = (fFlagsData) => {
            let flagsHtml = `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">User Account Control Value</h3>
                    <p class="text-3xl font-mono font-bold text-indigo-600 mt-2">${fFlagsData.uac_flag_sum_decimal}</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Active UAC Flags</h3>
                    <div class="space-y-3">
            `;

            if (fFlagsData.uac_flags_list && fFlagsData.uac_flags_list.length > 0) {
                fFlagsData.uac_flags_list.forEach(flag => {
                    flagsHtml += `
                        <div class="p-4 border border-gray-200 rounded-lg bg-white">
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-gray-800">${flag['Flag Name']}</p>
                                <span class="text-sm font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded">${flag['Hex Value']}</span>
                            </div>
                            <p class="text-gray-600 mt-1">${flag['Description']}</p>
                            <p class="text-xs text-gray-400 mt-2">Decimal: ${flag['Decimal Value']}</p>
                        </div>
                    `;
                });
            } else {
                flagsHtml += '<p class="text-gray-500 text-center p-4">No active UAC flags found.</p>';
            }

            flagsHtml += '</div></div>';
            uacFlagsContainer.innerHTML = flagsHtml;
        };

        const renderRawDataTable = (data, listElement) => {
            listElement.innerHTML = '';
            data.forEach(item => {
                listElement.innerHTML += createDetailRow(item.field, item.value);
            });
        };

        const renderAiSummary = (summaryData) => {
            aiSummaryLoading.classList.add('hidden');
            aiSummaryContent.classList.remove('hidden');

            if (summaryData.status !== 'passed' || !summaryData.summary) {
                aiSummaryContent.innerHTML = '<p class="text-red-500 p-4 bg-red-50 rounded-lg">Could not generate AI summary.</p>';
                return;
            }

            const summaryText = summaryData.summary;
            let html = '<div class="space-y-4">';

            // Split the text into sections based on double newlines.
            const sections = summaryText.split(/\n\s*\n/);

            sections.forEach(sectionText => {
                const trimmedSection = sectionText.trim();
                if (!trimmedSection) return;

                // Find the title, e.g., **1. Key Correspondents:**
                const titleMatch = trimmedSection.match(/^\*\*(.*?):\*\*/);
                if (!titleMatch) {
                    // If no title, treat as a simple paragraph in its own box
                    html += `<div class="p-4 border border-gray-200 rounded-lg bg-white">${trimmedSection.replace(/\n/g, '<br>')}</div>`;
                    return;
                }

                const title = titleMatch[1].replace(/^\d+\.\s*/, '');
                const content = trimmedSection.substring(titleMatch[0].length).trim();

                html += `<div class="p-4 border border-gray-200 rounded-lg bg-white">`;
                html += `<h4 class="font-semibold text-gray-800 mb-2">${title}</h4>`;

                let contentHtml = '';
                let inList = false;
                const lines = content.split('\n').filter(l => l.trim());

                lines.forEach(line => {
                    const boldedLine = line.trim().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                    if (boldedLine.startsWith('*')) {
                        if (!inList) {
                            contentHtml += '<ul class="list-disc pl-5 space-y-1 text-gray-600">';
                            inList = true;
                        }
                        contentHtml += `<li>${boldedLine.substring(1).trim()}</li>`;
                    } else {
                        if (inList) {
                            contentHtml += '</ul>';
                            inList = false;
                        }
                        contentHtml += `<p class="text-gray-600 mt-2">${boldedLine}</p>`;
                    }
                });

                if (inList) {
                    contentHtml += '</ul>'; // Close any open list at the end
                }

                html += contentHtml;
                html += `</div>`; // Close section box
            });

            html += '</div>'; // Close space-y-4 container
            aiSummaryContent.innerHTML = html;
        };

        const renderEmailsTable = (emails) => {
            emailsLoading.classList.add('hidden');
            const table = emailsTableContainer.querySelector('table');
            table.classList.remove('hidden');

            if (!emails || emails.length === 0) {
                emailsList.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">No emails found for this user.</td></tr>`;
                return;
            }

            emailsList.innerHTML = ''; // Clear previous entries
            emails.forEach((email, index) => {
                const row = document.createElement('tr');
                row.classList.add('cursor-pointer', 'hover:bg-gray-50');
                row.dataset.index = index;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${email.from_addr}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${email.to_addr}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${email.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${email.date}</td>
                `;

                const detailRow = document.createElement('tr');
                detailRow.classList.add('hidden');
                detailRow.innerHTML = `<td colspan="4" class="p-4 bg-gray-50"><pre class="email-body">${email.body}</pre></td>`;

                emailsList.appendChild(row);
                emailsList.appendChild(detailRow);

                row.addEventListener('click', () => {
                    detailRow.classList.toggle('hidden');
                });
            });
        };


        // --- Main Execution ---
        const loadAllData = async () => {
            try {
                // Fetch primary profile data
                const [fDataRes, vDataRes, fFlagsRes] = await Promise.all([
                    fetch(fValueApiUrl),
                    fetch(vValueApiUrl),
                    fetch(fValueFlagsApiUrl)
                ]);

                if (!fDataRes.ok || !vDataRes.ok || !fFlagsRes.ok) throw new Error('One or more API requests failed.');

                const fData = await fDataRes.json();
                const vData = await vDataRes.json();
                const fFlags = await fFlagsRes.json();

                if (fData.status !== 'passed' || vData.status !== 'passed' || fFlags.status !== 'passed') throw new Error('One or more API responses reported a failure.');

                const normalizedVData = vData.v_val.map(item => ({ field: item.field, value: item.actual_data }));

                renderCombinedProfile(fData.f_val, normalizedVData);
                renderUACFlags(fFlags.f_val);
                renderRawDataTable(fData.f_val, rawFValueList);
                renderRawDataTable(normalizedVData, rawVValueList);

                loadingState.classList.add('hidden');
                successState.classList.remove('hidden');

            } catch (error) {
                console.error("Error loading profile data:", error);
                loadingState.classList.add('hidden');
                // Handle error display properly
            }
        };

        const loadEmailData = async () => {
            // First, fetch and render the emails list
            try {
                const emailsRes = await fetch(emailsApiUrl);
                const emails = await emailsRes.json();
                renderEmailsTable(emails);
            } catch (error) {
                console.error("Error loading emails list:", error);
                emailsLoading.classList.add('hidden');
                emailsTableContainer.querySelector('table').classList.remove('hidden');
                emailsList.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">No Emails Found</td></tr>`;
            }

            // Wait for 10 seconds before fetching the AI summary
            await delay(10000);

            // Second, fetch and render the AI summary
            try {
                const aiSummaryRes = await fetch(emailAiAnalysisApiUrl);
                const aiSummary = await aiSummaryRes.json();
                renderAiSummary(aiSummary);
            } catch (error) {
                console.error("Error loading AI summary:", error);
                aiSummaryLoading.classList.add('hidden');
                aiSummaryContent.innerHTML = '<p class="text-red-500">AI summary not available.</p>';
                aiSummaryContent.classList.remove('hidden');
            }
        };

        // --- Event Listeners for Expanders ---
        toggleEmailsBtn.addEventListener('click', () => {
            const isHidden = emailsContainer.classList.toggle('hidden');
            toggleEmailsBtn.querySelector('.chevron-icon').classList.toggle('rotate-180');
            // Load email data only when the accordion is first opened
            if (!isHidden && !emailsContainer.dataset.loaded) {
                loadEmailData();
                emailsContainer.dataset.loaded = 'true';
            }
        });

        toggleUACBtn.addEventListener('click', () => {
            uacFlagsContainer.classList.toggle('hidden');
            toggleUACBtn.querySelector('.chevron-icon').classList.toggle('rotate-180');
        });

        toggleFValueBtn.addEventListener('click', () => {
            rawFValueContainer.classList.toggle('hidden');
            toggleFValueBtn.querySelector('.chevron-icon').classList.toggle('rotate-180');
        });

        toggleVValueBtn.addEventListener('click', () => {
            rawVValueContainer.classList.toggle('hidden');
            toggleVValueBtn.querySelector('.chevron-icon').classList.toggle('rotate-180');
        });

        // --- Initial Call ---
        if (partitionId && userRid) {
            loadAllData();
        } else {
            // Handle missing ID error
        }
    });
</script>

</body>
</html>
